---
 title: 从键入 URL 到页面渲染都经历了什么-草稿
 date: 2018-08-20
 tags: 浏览器原理
---

## 客户端键入 URL
用户键入 url，浏览器会先后经历 DNS寻址、TCP/IP建立链接、发出html请求、接收html的过程，此后浏览器将开始解析 html 中的内容生成 Dom、Cssom，并根据他们来计算所有可见元素的样式创建出 RenderTree，再为 RenderTree 中每一个 Layer（渲染层）确定元素的位置和尺寸，最终完成像素在屏幕上的绘制。

## DNS 寻址

## TCP/IP建立链接（http2/http3）

## 接受 html（web缓存机制）

## HTML解析过程
1. 主线程开始从上到下执行以构建 Dom 树，直到最后一个字节被解析完毕 
  - 当遇到立即执行的 script 脚本时，文档解析停止，直到执行完成
  - 在执行脚本时，另一个线程会解析文档的其余部分，找到外部资源并触发加载，这个过程也叫推测解析。
  - 当找到一个外部链接，浏览器将生成一个请求（js、css、img）
  - 无 async、defer 属性（同步js）的 script 资源请求将阻塞后续html解析，只有在资源请求并执行结束后才继续解析。
  - css、img 的资源请求不会阻塞后续html解析，浏览器在触发资源请求的同时仍继续解析。
  - css 的资源请求在加载和解析时，Firefox 会阻塞所有 script 脚本执行；WebKit 仅在 script 脚本试图访问某些可能未生效的样式属性时才阻止脚本。
2. 构建 Dom 树时，同时会构建 cssom 树。【至此，html已解析完成，如果同步的Js执行完成，将进行 DomReady 打点】
  - Dom 树种有可视化节点（div、span等）、非可视化节点（script、meta、link、title等）。
  - cssom 树构建不会影响解析。
  - Dom 树构建的同时会构建 RenderTree，并计算每个节点的样式。Dom树是从代码层面输出的层级，渲染树是通过是否可视来输出的层级（只有可视的节点）。
  - 设置成 defer 的 script 脚本虽然不会阻塞 html 解析，但是会阻塞布局，在html解析完成后才开始下载脚本，执行脚本并触发 Dom 树更新，再进行布局。而async的脚本则不会阻塞布局和绘制。
3. 布局
4. 绘制。绘制第一个像素时会完成 FP 的打点。
  当 html 中Dom节点很多时渲染引擎会尝试先绘制一部分再解析。
  当 html 中Dom节点少的时候会在解析完成之后再统一绘制。

## 性能指标及含义、治理建议